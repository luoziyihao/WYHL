# 职责

- 对内: 支付流水-账户流水对账, 试算平衡, 资产负债, 收入损益
 
- 对外: 清分, 对账, 清算, 结算


对账: 是对现有的支付流水, 对应收账款
清结算： 是对即将支付的流水, 对应应付款

# 简单流程

- 每5分钟跑批

支付流水-账户流水对账

- 凌晨清结算
 
对账准备 -> 渠道侧对账, 商户侧对账 -> 清分 -> 清算 -> 结算 -> 试算平衡 -> 核账


# 数据实体

## 支付流水-账户流水对账

- 内部对账结果表， 记录内部对账的结果

关键字段: 借贷方 id, 借贷方标识, 借贷方金额, 对账状态

## 清分

### 对账准备
- 渠道侧对账单原始数据表 (原始对账单数据导入)
- 渠道侧对账单记录表 (根据对账单数据生成)
- 公司侧对渠道侧对账单记录表 (根据对渠道侧支付流水生成)
- 公司侧对商户侧对账单记录表 (根据对商户侧支付流水生成)

## 对账

- 商户侧对账流水表(支付成功后, 就会异步针对支付记录生成一笔待对账流水, 同时生成对应的公司对商户侧对账单)
- 渠道侧对账流水表

### 对渠道侧清分
- 清分流水表(待清算充值账户流水累计和余额的比对结果)

### 对商户清分
- 清分流水表(待清算回款账户流水累计和余额的比对结果)

## 清算
- 商户侧清算流水表 (拿清分的结果和渠道侧的应收应付数据比对)

## 结算
- 商户侧结算流水表 (结算划转的流水)

## 试算平衡
- 支付流水试算平衡流水表
- 日结发生额试算平衡流水表

## 报表
- 损益表
- 资产负债表
- 试算表


# 行为(接口)
 
 时间线的所有行为
 

# 异常行为

清结算主要涉及的记录都是流水表, 流水表中都存在 state 字段， state 字段主要是这几个状态 开始, 异常, 成功, 失败

异常是程序bug 导致的 state 异常, 失败是业务流程失败导致的状态

针对清结算过程中的所有流程会有 管理后台查看并监控 state 异常或者失败的记录


## 支付流水对账

监控短信 人工审核刷新

## 凌晨清结算

### 对账准备 

监控短信 人工审核刷新

### 对账

以渠道侧为准 调发生额


### 对渠道清分 

以对账后的流水为准 调发生额

### 清算

对商户侧, 需要查询在商户侧的欠款和服务端清分后的应发生额是否一致

### 结算

划转
